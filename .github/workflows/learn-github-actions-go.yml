name: Go CI Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_call:
    inputs:
      working-directory:
        description: 'Directory to the folder in which the app is located.'
        required: true
        type: string
        default: 'src'
      
      artifact-name:
        required: false
        type: string
        default: ${{ github.event.repository.name }}

jobs:

  build:
    name: Build and upload
    runs-on: ubuntu-22.04
  
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with: 
          fetch-depth: 0


      - name: Determine tag
        id: tag
        #if: startsWith( github.ref, 'refs/heads/main' )
        run: |
          VERSION=`git tag -l --sort -version:refname | head -n 1`
          VERSION_BITS=(${VERSION//./ })
          VNUM1=${VERSION_BITS[0]}
          [[ $VNUM1 = '' ]] && VNUM1="0" || VNUM1="$VNUM1"
          VNUM2=${VERSION_BITS[1]}
          [[ $VNUM2 = '' ]] && VNUM2="0" || VNUM2="$VNUM1"
          VNUM3=${VERSION_BITS[2]}
          [[ $VNUM3 = '' ]] && VNUM3="0" || VNUM3="$VNUM1"
          VNUM4=$((VNUM3+1))
          NEW_TAG="$VNUM1.$VNUM2.$VNUM4"
          git tag $NEW_TAG
          git push origin --tags

      - name : get tag
        id: latest_tag 
        if: startsWith( github.ref, 'refs/heads/main' )
        uses: oprypin/find-latest-tag@v1
        with:
          repository: ${{ github.repository }}
          releases-only: false 
          fallback: v0.0.0